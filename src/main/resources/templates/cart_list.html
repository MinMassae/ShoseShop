<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚«ãƒ¼ãƒˆãƒªã‚¹ãƒˆ</title>
  <style>
    body { font-family: Arial, sans-serif; }
    header {
      padding: 10px; background-color: #f0f0f0;
      display: flex; justify-content: space-between; align-items: center;
    }
    #logo { cursor: pointer; }
    nav ul { list-style: none; display: flex; gap: 15px; margin: 0; padding: 0; }
    nav ul li a { text-decoration: none; color: #333; }
    aside { float: left; width: 200px; padding: 10px; }
    main { margin-left: 220px; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 8px; text-align: center; }
    button { padding: 6px 12px; font-size: 14px; border: none; border-radius: 5px; cursor: pointer; }
    .btn-update { background-color: #4CAF50; color: white; margin-right: 5px; }
    .btn-update:hover { background-color: #45a049; }
    .btn-delete { background-color: #f44336; color: white; }
    .btn-delete:hover { background-color: #da190b; }
  </style>
</head>
<body>

<header>
  <div id="logo" onclick="location.href='/'">ğŸ‘Ÿ ShoseShop</div>
  <nav><ul id="menu"></ul></nav>
</header>

<aside>
  <h3>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
  <ul>
    <li><a href="/mypage">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±</a></li>
    <li><a href="/mypage/cart">ã‚«ãƒ¼ãƒˆãƒªã‚¹ãƒˆ</a></li>
    <li><a href="/mypage/orders">æ³¨æ–‡å±¥æ­´</a></li>
  </ul>
</aside>

<main>
  <h2>ğŸ›’ ã‚«ãƒ¼ãƒˆãƒªã‚¹ãƒˆ</h2>
  <table id="cartTable">
    <thead>
    <tr>
      <th>é¸æŠ</th>
      <th>å•†å“å</th>
      <th>ã‚µã‚¤ã‚º</th>
      <th>æ•°é‡</th>
      <th>ä¾¡æ ¼</th>
      <th>å°è¨ˆ</th>
      <th>æ“ä½œ</th>
    </tr>
    </thead>
    <tbody id="cartBody"></tbody>
  </table>

  <div style="margin-top: 20px;">
    <button id="orderButton" style="padding:10px 20px; font-size:16px;">é¸æŠã—ãŸå•†å“ã‚’æ³¨æ–‡ã™ã‚‹</button>
  </div>
</main>

<script>
  const token = localStorage.getItem("accessToken");
  const menu = document.getElementById("menu");

  if (token) {
    menu.innerHTML = `
      <li><a href="#" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a></li>
      <li><a href="/mypage">ãƒã‚¤ãƒšãƒ¼ã‚¸</a></li>
      <li><a href="/board">æ²ç¤ºæ¿</a></li>
    `;
  } else {
    menu.innerHTML = `
      <li><a href="/login">ãƒ­ã‚°ã‚¤ãƒ³</a></li>
      <li><a href="/register">ä¼šå“¡ç™»éŒ²</a></li>
      <li><a href="/board">æ²ç¤ºæ¿</a></li>
    `;
  }

  function logout() {
    localStorage.removeItem("accessToken");
    location.href = "/login";
  }

  function loadCartList() {
    if (!token) {
      alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚");
      location.href = "/login";
      return;
    }

    fetch("/api/cart/list", {
      method: "GET",
      headers: { "Authorization": "Bearer " + token }
    })
            .then(response => {
              if (!response.ok) throw new Error("ã‚«ãƒ¼ãƒˆãƒªã‚¹ãƒˆå–å¾—å¤±æ•—");
              return response.json();
            })
            .then(data => {
              const tbody = document.getElementById("cartBody");
              tbody.innerHTML = "";

              data.forEach(item => {
                const sizeOptions = item.availableSizes.map(sizeInfo => `
          <option value="${sizeInfo.size}" ${sizeInfo.size === item.size ? 'selected' : ''}>
            ${sizeInfo.size} (${sizeInfo.stock}å€‹)
          </option>
        `).join('');

                const selectedStock = item.availableSizes.find(s => s.size === item.size)?.stock || 1;

                const row = `
          <tr>
            <td><input type="checkbox" class="cart-checkbox" value="${item.id}"></td>
            <td>${item.productName}</td>
            <td>
              <select id="size-${item.id}" onchange="updateMaxQuantity(${item.id}, ${JSON.stringify(item.availableSizes).replace(/"/g, '&quot;')})">
                ${sizeOptions}
              </select>
            </td>
            <td>
              <input type="number" id="quantity-${item.id}" value="${item.quantity}" min="1" max="${selectedStock}"
                     onchange="updateSubtotal(${item.id}, ${item.price})">
            </td>
            <td>${item.price}å††</td>
            <td id="subtotal-${item.id}">${item.price * item.quantity}å††</td>
            <td>
              <button class="btn-update" onclick="updateCart(${item.id})">å¤‰æ›´</button>
              <button class="btn-delete" onclick="deleteCart(${item.id})">ğŸ—‘ï¸å‰Šé™¤</button>
            </td>
          </tr>
        `;
                tbody.innerHTML += row;
              });
            })
            .catch(error => {
              console.error(error);
              alert("ã‚«ãƒ¼ãƒˆãƒªã‚¹ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
              location.href = "/login";
            });
  }

  function updateSubtotal(cartId, price) {
    const quantityInput = document.getElementById(`quantity-${cartId}`);
    const subtotalTd = document.getElementById(`subtotal-${cartId}`);
    const quantity = parseInt(quantityInput.value) || 0;
    subtotalTd.textContent = (price * quantity) + "å††";
  }

  function updateMaxQuantity(cartId, availableSizes) {
    const selectedSize = parseInt(document.getElementById(`size-${cartId}`).value);
    const stockInfo = availableSizes.find(s => s.size === selectedSize);
    const quantityInput = document.getElementById(`quantity-${cartId}`);
    const subtotalTd = document.getElementById(`subtotal-${cartId}`);
    if (stockInfo) {
      quantityInput.max = stockInfo.stock;
      if (parseInt(quantityInput.value) > stockInfo.stock) {
        quantityInput.value = stockInfo.stock;
      }
      const price = parseInt(subtotalTd.previousElementSibling.textContent.replace("å††", ""));
      subtotalTd.textContent = (price * parseInt(quantityInput.value)) + "å††";
    }
  }

  function updateCart(cartId) {
    const size = document.getElementById(`size-${cartId}`).value;
    const quantity = document.getElementById(`quantity-${cartId}`).value;

    fetch("/api/cart/update", {
      method: "PUT",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
      body: JSON.stringify({ cartId, size, quantity })
    })
            .then(res => {
              if (!res.ok) throw new Error("ä¿®æ­£ã‚¨ãƒ©ãƒ¼");
              alert("ã‚«ãƒ¼ãƒˆæƒ…å ±ã‚’ä¿®æ­£ã—ã¾ã—ãŸï¼");
              location.reload();
            })
            .catch(err => {
              alert("ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            });
  }

  function deleteCart(cartId) {
    if (!confirm("ã“ã®å•†å“ã‚’ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

    fetch(`/api/cart/delete/${cartId}`, {
      method: "DELETE",
      headers: { "Authorization": "Bearer " + token }
    })
            .then(res => {
              if (!res.ok) throw new Error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼");
              alert("ã‚«ãƒ¼ãƒˆã‹ã‚‰å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼");
              location.reload();
            })
            .catch(err => {
              alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            });
  }

  // âœ… "ì„ íƒëœ ìƒí’ˆ ì£¼ë¬¸í•˜ê¸°" â†’ ì£¼ë¬¸í™•ì¸í˜ì´ì§€ë¡œ ì´ë™
  document.getElementById("orderButton").addEventListener("click", function() {
    const checkedBoxes = document.querySelectorAll(".cart-checkbox:checked");
    const selectedCartIds = Array.from(checkedBoxes).map(cb => cb.value);

    if (selectedCartIds.length === 0) {
      alert("æ³¨æ–‡ã™ã‚‹å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const queryString = selectedCartIds.map(id => `cartIds=${id}`).join("&");
    window.location.href = `/order/confirm?${queryString}`;
  });

  document.addEventListener("DOMContentLoaded", loadCartList);
</script>

</body>
</html>
